/**
 * fe-error-monitor v1.0.0
 * Copyright 2018-2019 Ranjay
 * Released under the Apache License
 * https://github.com/jerryOnlyZRJ/fe-error-monitor
 */
!function(t,e){"undefined"==typeof module?t.ErrorMonitor=e():module.exports=e()}(this,function(){"use strict";function r(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this.xhr=new XMLHttpRequest,this.xhr.send=XMLHttpRequest.prototype.send,this.xhr.open=XMLHttpRequest.prototype.open,this.monitorResult={}}var t,n,o;return t=e,(n=[{key:"uploadMonitorLogs",value:function(){if(this.options.url){if(navigator.sendBeacon&&"function"==typeof navigator.sendBeacon){var t=new window.Blob([JSON.stringify(this.monitorResult)],{type:"application/json"});navigator.sendBeacon(this.options.url,t)}else if("fetch"in window)window.fetch(this.options.url,{method:"POST",body:JSON.stringify(this.monitorResult)});else if("XMLHttpRequest"in window&&"function"==typeof window.XMLHttpRequest){var e=new window.XMLHttpRequest;e.open("POST",this.options.url),e.send(JSON.stringify(this.monitorResult))}}else window.localStorage&&window.localStorage.setItem("errorLog",JSON.stringify(this.monitorResult))}},{key:"addResult",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};e.time=(new Date).getTime(),e.url=window.location.href,this.monitorResult[t]?this.monitorResult[t].push(e):this.monitorResult[t]=[e]}},{key:"init",value:function(){var s,e,n,a=this,t=function(){if("fetch"in window&&"function"==typeof window.fetch){var e=window.fetch,r=a;window.fetch=function(t,o){return e.apply(this,arguments).then(function(n){return n.ok||e(t,o).then(function(t){return t.text()}).then(function(t){var e={type:"FetchError",src:n.url,status:n.status,method:o&&o.method||"GET",response:t};r.addResult("ajax",e)}),n})}}},o=function(){var n=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send,r=a.addResult.bind(a),i="GET";XMLHttpRequest.prototype.open=function(t,e){i=t,n.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){var e=this;o.call(e,t);var n=e.onreadystatechange;e.onreadystatechange=function(){if(4===e.readyState&&!/20[1-9]/.test(e.status)){var t={type:"XMLHttpRequestError",src:e.responseURL,method:i,status:e.status,response:e.responseText};r("ajax",t)}n&&n.apply(e,arguments)}}};s=window.onerror,window.onerror=function(t,e,n,o,r){s&&s(t,e,n,o,r);var i={type:"Error",message:t,src:e,line:n,column:o,error:r};return a.addResult("error",i),!0},window.addEventListener("error",function(t){if(t.target!==window){var n=t.target;return n.src&&(a.xhr.open("HEAD",n.src),a.xhr.send(),a.xhr.onload=function(t){var e={type:"ResourceError",outerHTML:n.outerHTML,src:n.src,status:t.target.status,response:t.target.responseText};a.addResult("resourceError",e)}),!1}},!0),window.addEventListener("unhandledrejection",function(t){var e={type:"Unhandledrejection",message:t.reason};a.addResult("unhandledrejection",e)}),t(),o(),e=window.onload,window.onload=function(t){e&&"function"==typeof e&&e(t),window.requestIdleCallback?window.requestIdleCallback(a.uploadMonitorLogs.bind(a)):setTimeout(a.uploadMonitorLogs.bind(a))},document.createElement=(n=document.createElement.bind(document),function(t){var e=n(t);return"script"===t&&(e.crossOrigin="anonymous"),e})}}])&&r(t.prototype,n),o&&r(t,o),e}()});